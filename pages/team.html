<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DarkOS â€“ Team Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Inter:wght@300;400;500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/dashboard.css" />
</head>
<body>
<div class="noise"></div>

<div class="login-overlay" id="loginOverlay">
  <div class="auth-card">
    <div style="font-size:3rem;margin-bottom:1rem">ğŸ›¡ï¸</div>
    <h2 id="loginTitle">Team Portal</h2>
    <p style="color:var(--text-dim);margin-bottom:1.8rem;font-size:0.88rem">Team role required. Admin roles have full access.</p>
    <button class="btn-discord" onclick="loginWithDiscord()">
      <svg width="20" height="20" viewBox="0 0 127.14 96.36" fill="currentColor"><path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/></svg>
      Login with Discord
    </button>
    <div id="loginError" style="color:var(--accent3);font-size:0.8rem;margin-top:1rem;display:none"></div>
  </div>
</div>

<div class="dash-layout" id="portalLayout" style="display:none">
  <div class="sidebar">
    <div class="sidebar-brand">ğŸ›¡ï¸ <span style="color:var(--accent2)">Team</span></div>
    <button class="nav-item active" onclick="showPage('tickets', this)">ğŸ« Tickets</button>
    <button class="nav-item"       onclick="showPage('stats',   this)">ğŸ“Š Statistics</button>
    <div id="adminLink" style="display:none">
      <div style="font-size:0.7rem;color:var(--text-dim);padding:0.5rem;text-transform:uppercase;letter-spacing:0.1em">Admin</div>
      <button class="nav-item" onclick="window.location.href='admin.html'">âš™ï¸ Dashboard</button>
    </div>
    <div style="flex:1"></div>
    <div class="user-pill">
      <img id="userAvatar" src="" alt="" />
      <span id="userName">â€”</span>
    </div>
    <button class="nav-item" style="margin-top:0.4rem;color:var(--accent3)" onclick="logout()">ğŸšª Logout</button>
  </div>

  <div class="main-area">
    <div class="page active" id="page-tickets">
      <div class="page-title">ğŸ« Open Tickets</div>
      <div id="roleInfoBanner" style="background:rgba(44,182,125,0.1);border:1px solid rgba(44,182,125,0.3);border-radius:8px;padding:0.7rem 1rem;font-size:0.83rem;color:var(--accent2);margin-bottom:1.5rem">Loading...</div>
      <div id="ticketsList">
        <div style="text-align:center;padding:3rem;color:var(--text-dim)">
          <div style="font-size:3rem">ğŸ«</div>
          <p>No open tickets at this time. ğŸ‰</p>
        </div>
      </div>
    </div>

    <div class="page" id="page-stats">
      <div class="page-title">ğŸ“Š Statistics</div>
      <div class="stat-grid" id="teamStatsGrid">
        <div class="stat-box"><div class="stat-box-num" id="ts-members">â€”</div><div class="stat-box-lbl">Members</div></div>
        <div class="stat-box"><div class="stat-box-num" id="ts-tickets">â€”</div><div class="stat-box-lbl">Tickets</div></div>
        <div class="stat-box"><div class="stat-box-num" id="ts-messages">â€”</div><div class="stat-box-lbl">Messages</div></div>
        <div class="stat-box"><div class="stat-box-num" id="ts-joins">â€”</div><div class="stat-box-lbl">Joins</div></div>
        <div class="stat-box"><div class="stat-box-num" id="ts-leaves">â€”</div><div class="stat-box-lbl">Leaves</div></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="../config.js"></script>
<script>
  const C = window.DARKOS || {};
  const CLIENT = C.clientId || '1425314501057839174';
  const GUILDID = C.guildId || '1023175719209144380';
  let accessToken = null;

  // â”€â”€ OAuth2 Implicit Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const REDIRECT_URI = window.location.href.split('?')[0].split('#')[0];
  const OAUTH_URL = 'https://discord.com/oauth2/authorize' +
    '?client_id=' + encodeURIComponent(CLIENT) +
    '&response_type=token' +
    '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
    '&scope=identify+guilds';

  function loginWithDiscord() {
    window.location.href = OAUTH_URL;
  }

  async function handleToken(token) {
    try {
      const userRes = await fetch('https://discord.com/api/users/@me', {
        headers: { Authorization: 'Bearer ' + token }
      });
      const user = await userRes.json();
      if (!user.id) { showErr('âŒ Discord Login fehlgeschlagen.'); return; }

      const guildsRes = await fetch('https://discord.com/api/users/@me/guilds', {
        headers: { Authorization: 'Bearer ' + token }
      });
      const guilds = await guildsRes.json();
      const guild = Array.isArray(guilds) && guilds.find(g => g.id === GUILDID);

      if (!guild) { showErr('âŒ Du bist nicht im Community Server.'); return; }

      const isAdmin = guild.owner || (BigInt(guild.permissions) & BigInt(0x8)) !== BigInt(0);
      const isMod   = isAdmin || (BigInt(guild.permissions) & BigInt(0x2)) !== BigInt(0); // Manage Messages

      if (!isMod && !isAdmin) {
        showErr('âŒ Du benÃ¶tigst eine Team-Rolle auf dem Community Server.');
        return;
      }

      accessToken = token;
      sessionStorage.setItem('dkos_team_token', token);
      sessionStorage.setItem('dkos_team_user', JSON.stringify(user));
      sessionStorage.setItem('dkos_team_isAdmin', isAdmin ? '1' : '0');
      showPortal(user, isAdmin);
      window.history.replaceState({}, '', window.location.pathname);
    } catch (e) {
      showErr('âŒ Fehler: ' + e.message);
    }
  }

  function showPortal(user, isAdmin) {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('portalLayout').style.display = 'grid';
    document.getElementById('userName').textContent = user.username || user.global_name || '?';
    if (user.avatar) {
      document.getElementById('userAvatar').src =
        'https://cdn.discordapp.com/avatars/' + user.id + '/' + user.avatar + '.png?size=64';
    }
    if (isAdmin) document.getElementById('adminLink').style.display = 'block';
    document.getElementById('roleInfoBanner').textContent = isAdmin
      ? 'â­ Logged in as Admin â€“ full access.'
      : 'ğŸ›¡ï¸ Logged in as Team Member.';
  }

  function logout() {
    sessionStorage.removeItem('dkos_team_token');
    sessionStorage.removeItem('dkos_team_user');
    sessionStorage.removeItem('dkos_team_isAdmin');
    location.reload();
  }

  function showErr(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg; el.style.display = 'block';
  }

  function showPage(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + id).classList.add('active');
    btn.classList.add('active');
  }

  window.addEventListener('load', () => {
    // Check URL hash for token
    const hash = new URLSearchParams(window.location.hash.slice(1));
    if (hash.get('access_token')) {
      handleToken(hash.get('access_token'));
      return;
    }
    // Restore session
    const token   = sessionStorage.getItem('dkos_team_token');
    const user    = sessionStorage.getItem('dkos_team_user');
    const isAdmin = sessionStorage.getItem('dkos_team_isAdmin') === '1';
    if (token && user) {
      accessToken = token;
      showPortal(JSON.parse(user), isAdmin);
    }
  });

  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3500);
  }
</script>
</body>
</html>
